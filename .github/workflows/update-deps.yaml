name: Check for newer dependencies

on:
  schedule:
    - cron: "37 0 * * *"
  workflow_dispatch:

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  check_deps:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout build scripts
        uses: actions/checkout@v3
      - name: Read build.env
        id: buildenv
        uses: falti/dotenv-action@v1
        with:
          path: build.env
          log-variables: true
          mask-variables: false
      - name: Export build.env
        run: |
          echo "SBCL_HOST_VERSION=${{ steps.buildenv.outputs.sbcl_host_version }}" >> ${GITHUB_ENV}
          echo "SBCL_VERSION=${{ steps.buildenv.outputs.sbcl_version }}" >> ${GITHUB_ENV}
          echo "LIBFIXPOSIX_VERSION=${{ steps.buildenv.outputs.libfixposix_version }}" >> ${GITHUB_ENV}
          echo "OPENSSL_VERSION=${{ steps.buildenv.outputs.openssl_version }}" >> ${GITHUB_ENV}
          echo "REVISION=${{ steps.buildenv.outputs.revision }}" >> ${GITHUB_ENV}
      - name: Install build deps
        run: |
          cat > sources.list << EOF
          deb-src http://archive.ubuntu.com/ubuntu focal main restricted universe multiverse
          deb-src http://archive.ubuntu.com/ubuntu focal-updates main restricted universe multiverse
          deb-src http://security.ubuntu.com/ubuntu focal-security main restricted universe multiverse
          EOF
          sudo mv sources.list /etc/apt/sources.list.d/
          sudo apt -y update
          sudo apt -y install libssl-dev=${{ env.OPENSSL_VERSION }}
      - name: Check deps
        run: scripts/check_deps.sh
